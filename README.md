# README

[![Build status](https://ci.appveyor.com/api/projects/status/45j0q24sg6aiiq52?svg=true)](https://ci.appveyor.com/project/diev/listxml)

Из системы СВК Банка России поступают файлы в зашифрованном виде. Штатное ПО "АРМ КБР" распаковывает их в подпапку `exg\chk\` на диске. А эта консольная программа, запускаемая системным планировщиком, интеллектуально обрабатывает полученное: извлекает содержимое `sen:Object`, гибко разбирает XML и перераспределяет по заданным спискам платежи (например, обслуживание по разным тарифам, клиентские и банковские) и выполняет предписанные действия - например, откладывает для отправки в ГИС ГМП/СМЭВ или рассылает оповещения по заданным адресам email в случае прихода каких-то конкретных документов, вкладывая их содержимое.

Проект ведется в [Microsoft Visual Studio Community 2015](https://www.visualstudio.com/) (ПО доступно бесплатно, включая коммерческое использование) на языке C#.

Для компиляции и запуска программы минимально достаточно иметь установленным в системе **Microsoft .NET 4 Client Profile**, который поддерживается операционными системами Microsoft, начиная от Windows XP SP3 и выше.

Для компиляции без установленной Visual Studio - запустите прилагаемый `make.cmd`.

## Как это запустить?

* **Быстрый старт:** откорректировать `Bank.cs` на свои константы (`БИК`, `К/сч`, `UIC`), скомпилировать с помощью `make.cmd` и поместить app.exe и его config в папку с АРМ КБР (рекомендуется в корень `c:\uarm3\`, чтобы использовать штатные подпапки по назначению, но можно и в любое другое).
* **Конфигурация:** `app.exe.config` (пути, опционально списки List1 и List2, почтовые настройки).
* **Что необходимо иметь:** [Microsoft .NET 4 Client Profile](https://www.microsoft.com/ru-RU/download/details.aspx?id=17113) или выше.
* **Настройка базы данных:** нет.
* **Получить помощь по программе:** `app.exe -h`.
* **Перенос на другое место:** скопировать `app.exe` и `app.exe.config`, убедиться в наличии `.NET 4`.

## Особенности конфигурирования и использования

* **PathChk** - путь к исходным файлам на выходе из АРМ КБР (обычно `exg\chk\`). Программа забирает все новые файлы оттуда к себе в хранилище, распределяя по датам атрибута `EDDate`.
* **PathXML** - путь для хранилища генерируемых файлов - там будет построено дерево подпапок по стадиям и в них по датам в `ГГГГ-ММ-ДД\` согласно `EDDate`. Файлы генерятся однократно по мере поступления. Ключ `-f` заставляет перегенерировать все заново. До 11:00 осуществляется обработка предыдущего рабочего дня. Ключ `-d` позволяет указать любую другую дату (рекомендуется совместно с `-f`).
* **PathOut** - путь для импорта в АБС - там будет построено дерево подпапок по спискам `List1`, `List2` и `List0`, куда попадут все прочие, что не совпали с номерами или конто из этих списков. Перепакованные файлы для импорта платежей формируются нарастающим итогом в течение дня для отказоустойчивости (переход на резервный компьютер не приводит к потере данных).
* **List1** - список полных 20-значных номеров счетов особых клиентов (например, обслуживаемых "под приход"), с разделителем по переводу строк (список в столбик).
* **List2** - список начальных знаков (конто, более или менее) по плану счетов, соответствующих банковским счетам, например, с разделителем по переводу строк (список в столбик). Как вариант - оба этих списка могут быть отдельными файлами вида `List1.txt` и `List2.txt` в папке с программой - тогда они будут использоваться вместо указанных в `app.exe.config`.
* Если адреса email не указаны, то соответствующей рассылки не производится; допускается указывать несколько адресов через запятую.
* Пароль в секции [mailSettings](https://msdn.microsoft.com/en-us/library/w355a94k(v=vs.100).aspx) должен быть закодирован в `Base64` (в отличие от стандартных настроек) для защиты от утечки при просмотре оператором. Не забудьте прописать свой SMTP host IP или DNS name (если пусто - отправки email не производятся) и имя отправителя также.
* Логи пишутся в подпапку хранилища в формате `log\ГГГГММДД_app.log` - мимикрия, приближенная под формат логов АРМ КБР).
* Полноту логов и отображения в консоли можно регулировать стандартными настройками в секции [system.diagnostics](https://msdn.microsoft.com/en-us/library/1txedc80(v=vs.100).aspx).

## Дополнительная информация на сайте Банка России

* [Унифицированные форматы электронных банковских сообщений Банка России. Обмен с клиентами Банка России](http://www.cbr.ru/analytics/Formats) (УФЭБС, XML).
* [Информация о новых версиях программного обеспечения](http://www.cbr.ru/mcirabis/?PrtId=itest) (СВК, АРМ КБР, УТА).

## Рекомендуемое альтернативное ПО в дополнение к этому

* [SVK Transport](https://bitbucket.org/html-applications/svk-transport) - прием и отправка платежной XML информации, бинарных информационных и файлов статистики по HTTP протоколу в систему СВК Банка России. Является легковесной заменой официальному ПО "УТА" или его коммерческим аналогам.
* [PTK-PSD Browser](https://bitbucket.org/html-applications/ptkpsd-browser) - наглядный просмотр и работа с архивом посылок ПТК ПСД Банка России. Является превосходным дополнением к установленному официальному ПО "Клиент ПТК ПСД".